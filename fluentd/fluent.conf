<source>
  @type tail
  path /log_volume/elastic.json
  tag json
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%LZ
</source>

<filter json>
  @type parser
  key_name message
  reserve_data true
  remove_key_name_field true
  emit_invalid_record_to_error false
  hash_value_field message_decoded
  <parse>
    @type json
  </parse>
</filter>

<filter json>
  @type record_transformer
  enable_ruby
  <record>
    clientIp ${if record.dig("message_decoded", "data", "clientIp"); record.dig("message_decoded", "data", "clientIp").split("::ffff:")[1]; else nil; end}
  </record>
  remove_keys timestamp
</filter>

<match json>
  @type opensearch
  host opensearch-node1
  port 9200
  user admin
  password admin
  index_name jelly_index
  pipeline geoip-info
  type_name _doc
  template_name jelly_template
  template_file /fluentd/etc/template.json
  template_overwrite true
  logstash_format true
  <buffer>
    @type memory
    flush_mode interval
    flush_interval 10s
    chunk_limit_size 2M
    chunk_limit_records 500
  </buffer>
</match>
